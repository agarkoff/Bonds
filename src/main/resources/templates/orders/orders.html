<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Å–¥–µ–ª–∫–∏ - Bonds</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .orders-count {
            background: #007bff;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .add-order-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.8em; /* –£–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç –¥–æ 80% */
        }
        
        .orders-table th,
        .orders-table td {
            padding: 6px 8px; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã */
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .orders-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .orders-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        .orders-table tbody tr.editing {
            background-color: #e3f2fd;
        }
        
        .group-header {
            background-color: #495057 !important;
            color: white;
            text-align: center;
            font-weight: bold;
        }
        
        .costs-group {
            border-left: 4px solid #ff9800;
        }
        
        .income-group {
            border-left: 4px solid #4caf50;
        }
        
        .results-group {
            border-left: 4px solid #9c27b0;
        }
        
        .currency::after {
            content: " ‚ÇΩ";
            color: #666;
        }
        
        .percentage::after {
            content: "%";
            color: #666;
        }
        
        .yield-cell {
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 3px;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .editable-cell {
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 3px;
        }
        
        .editable-cell:hover {
            background-color: #f0f0f0;
            border-color: #ccc;
        }
        
        .edit-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #007bff;
            border-radius: 3px;
            font-size: inherit;
        }
        
        .autocomplete {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 400px;
            width: max-content;
            max-width: 600px;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f0f0f0;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .navigation a {
            color: #007bff;
            text-decoration: none;
            margin: 0 15px;
            padding: 8px 16px;
            border: 1px solid #007bff;
            border-radius: 4px;
            display: inline-block;
        }
        
        .navigation a:hover {
            background: #007bff;
            color: white;
            text-decoration: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .orders-table {
                font-size: 12px;
            }
            
            .orders-table th,
            .orders-table td {
                padding: 4px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –ú–æ–∏ —Å–¥–µ–ª–∫–∏</h1>
            <div class="user-info">
                <span th:text="${user.displayName}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                <span class="orders-count" th:text="${ordersCount}">0</span>
                <a href="/" class="btn btn-secondary">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="/user/profile" class="btn btn-primary">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏ -->
        <div class="add-order-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–¥–µ–ª–∫—É</h3>
                <button id="toggleAddOrderBtn" class="btn btn-success btn-small">–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É</button>
            </div>
            <div id="addOrderForm" style="display: none;">
                <div id="addOrderError" class="error" style="display: none;"></div>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th class="group-header" colspan="6">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                            <th class="group-header costs-group" colspan="4">üí∞ –ó–∞—Ç—Ä–∞—Ç—ã</th>
                            <th class="group-header income-group" colspan="3">üìà –î–æ—Ö–æ–¥—ã</th>
                            <th class="group-header results-group" colspan="2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        <tr>
                            <th>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</th>
                            <th>ISIN</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            <th>–†–∞–∑–º–µ—Ä –∫—É–ø–æ–Ω–∞</th>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                            <th class="costs-group">–¶–µ–Ω–∞</th>
                            <th>–ù–ö–î</th>
                            <th>–ö–æ–º–∏—Å—Å–∏—è %</th>
                            <th>–ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç—ã</th>
                            <th class="income-group">–ù–æ–º–∏–Ω–∞–ª</th>
                            <th>–ö—É–ø–æ–Ω</th>
                            <th>–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥</th>
                            <th class="results-group">–ß–∏—Å—Ç–∞—è<br>–ø—Ä–∏–±—ã–ª—å</th>
                            <th>–ì–æ–¥–æ–≤–∞—è<br>–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="newOrderRow">
                            <td><input type="date" id="newPurchaseDate" class="edit-input" /></td>
                            <td>
                                <div class="autocomplete">
                                    <input type="text" id="newIsin" class="edit-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ISIN –∏–ª–∏ —Ç–∏–∫–µ—Ä" />
                                    <div id="isinDropdown" class="autocomplete-dropdown"></div>
                                </div>
                            </td>
                            <td id="newBondName">-</td>
                            <td id="newRating">-</td>
                            <td id="newCouponValue">-</td>
                            <td id="newCouponPeriod">-</td>
                            <td><input type="number" id="newPrice" class="edit-input" step="0.01" /></td>
                            <td id="newNkd">-</td>
                            <td><input type="number" id="newFeePercent" class="edit-input" step="0.01" value="0.3" /></td>
                            <td id="newTotalCosts">-</td>
                            <td id="newFaceValue">-</td>
                            <td id="newTotalCoupon">-</td>
                            <td id="newTotalIncome">-</td>
                            <td id="newNetProfit">-</td>
                            <td id="newAnnualYield">-</td>
                            <td>
                                <button id="saveNewOrderBtn" class="btn btn-success btn-small" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button id="cancelNewOrderBtn" class="btn btn-secondary btn-small">–û—Ç–º–µ–Ω–∞</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–¥–µ–ª–æ–∫ -->
        <div th:if="${orders.empty}" class="empty-state">
            <p>üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫.</p>
            <p>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É" –≤—ã—à–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Å–¥–µ–ª–∫—É.</p>
        </div>

        <div th:unless="${orders.empty}">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th class="group-header" colspan="6">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                        <th class="group-header costs-group" colspan="4">üí∞ –ó–∞—Ç—Ä–∞—Ç—ã</th>
                        <th class="group-header income-group" colspan="3">üìà –î–æ—Ö–æ–¥—ã</th>
                        <th class="group-header results-group" colspan="2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                    <tr>
                        <th>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</th>
                        <th>ISIN</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–†–µ–π—Ç–∏–Ω–≥</th>
                        <th>–†–∞–∑–º–µ—Ä –∫—É–ø–æ–Ω–∞</th>
                        <th>–ü–µ—Ä–∏–æ–¥</th>
                        <th class="costs-group">–¶–µ–Ω–∞</th>
                        <th>–ù–ö–î</th>
                        <th>–ö–æ–º–∏—Å—Å–∏—è %</th>
                        <th>–ò—Ç–æ–≥–æ –∑–∞—Ç—Ä–∞—Ç—ã</th>
                        <th class="income-group">–ù–æ–º–∏–Ω–∞–ª</th>
                        <th>–ö—É–ø–æ–Ω</th>
                        <th>–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥</th>
                        <th class="results-group">–ß–∏—Å—Ç–∞—è<br>–ø—Ä–∏–±—ã–ª—å</th>
                        <th>–ì–æ–¥–æ–≤–∞—è<br>–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="order : ${orders}" th:id="'order-row-' + ${order.id}" class="order-row">
                        <td class="editable-cell" th:onclick="'editOrderField(' + ${order.id} + ', \'purchaseDate\')'" 
                            th:text="${#temporals.format(order.purchaseDate, 'dd.MM.yyyy')}">01.01.2024</td>
                        <td th:text="${order.isin}">RU000A0JX0J2</td>
                        <td th:text="${order.bondName}">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏</td>
                        <td th:text="${order.rating}">AAA</td>
                        <td class="currency" th:text="${#numbers.formatDecimal(order.couponValue, 0, 2)}">25.00</td>
                        <td th:text="${order.couponPeriod} + ' –¥–Ω.'">91 –¥–Ω.</td>
                        <td class="currency editable-cell costs-group" th:onclick="'editOrderField(' + ${order.id} + ', \'priceAsk\')'"
                            th:text="${#numbers.formatDecimal(order.priceAsk, 0, 2)}">1000.00</td>
                        <td class="currency" th:text="${#numbers.formatDecimal(order.nkd, 0, 2)}">15.50</td>
                        <td class="percentage editable-cell" th:onclick="'editOrderField(' + ${order.id} + ', \'feePercent\')'"
                            th:text="${#numbers.formatDecimal(order.feePercent, 0, 2)}">0.30</td>
                        <td class="currency" th:text="${#numbers.formatDecimal(order.totalCosts, 0, 2)}">1018.50</td>
                        <td class="currency income-group" th:text="${#numbers.formatDecimal(order.faceValue, 0, 2)}">1000.00</td>
                        <td class="currency" th:text="${#numbers.formatDecimal(order.totalCoupon, 0, 2)}">50.00</td>
                        <td class="currency" th:text="${#numbers.formatDecimal(order.totalIncome, 0, 2)}">1050.00</td>
                        <td class="currency results-group" 
                            th:class="${order.netProfit != null && order.netProfit.compareTo(T(java.math.BigDecimal).ZERO) >= 0} ? 'currency positive' : 'currency negative'"
                            th:text="${#numbers.formatDecimal(order.netProfit, 0, 2)}">31.50</td>
                        <td class="percentage yield-cell" 
                            th:style="'background-color: ' + ${@yieldColorService.getYieldColor(order.annualYield)}"
                            th:text="${#numbers.formatDecimal(order.annualYield, 0, 2)}">18.50</td>
                        <td>
                            <button th:onclick="'editOrder(' + ${order.id} + ')'" class="btn btn-primary btn-small">‚úèÔ∏è</button>
                            <button th:onclick="'deleteOrder(' + ${order.id} + ')'" class="btn btn-danger btn-small">üóëÔ∏è</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="navigation">
            <a href="/">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="/user/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>

    <script>
        // –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º
        let availableBonds = [];
        let currentOrderId = null;
        let editingField = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableBonds();
            setupEventListeners();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('newPurchaseDate').value = new Date().toISOString().split('T')[0];
        });

        function setupEventListeners() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏
            document.getElementById('toggleAddOrderBtn').addEventListener('click', function() {
                const form = document.getElementById('addOrderForm');
                const btn = document.getElementById('toggleAddOrderBtn');
                
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    btn.textContent = '–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É';
                } else {
                    form.style.display = 'none';
                    btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É';
                }
            });

            // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è ISIN
            const isinInput = document.getElementById('newIsin');
            const dropdown = document.getElementById('isinDropdown');
            
            isinInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }

                const filtered = availableBonds.filter(bond => 
                    (bond.isin && bond.isin.toLowerCase().includes(query)) ||
                    (bond.ticker && bond.ticker.toLowerCase().includes(query)) ||
                    (bond.shortName && bond.shortName.toLowerCase().includes(query))
                ).slice(0, 10);

                if (filtered.length > 0) {
                    dropdown.innerHTML = filtered.map(bond => 
                        `<div class="autocomplete-item" data-isin="${bond.isin}">
                            <strong>${bond.isin}</strong> ${bond.ticker ? '(' + bond.ticker + ')' : ''}<br>
                            <small>${bond.shortName || bond.brandName || ''}</small>
                         </div>`
                    ).join('');
                    dropdown.style.display = 'block';
                } else {
                    dropdown.style.display = 'none';
                }
            });

            // –í—ã–±–æ—Ä –æ–±–ª–∏–≥–∞—Ü–∏–∏ –∏–∑ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item') || e.target.parentElement.classList.contains('autocomplete-item')) {
                    const item = e.target.classList.contains('autocomplete-item') ? e.target : e.target.parentElement;
                    const isin = item.dataset.isin;
                    selectBond(isin);
                }
            });

            // –°–∫—Ä—ã—Ç–∏–µ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete')) {
                    dropdown.style.display = 'none';
                }
            });

            // –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
            document.getElementById('saveNewOrderBtn').addEventListener('click', saveNewOrder);
            document.getElementById('cancelNewOrderBtn').addEventListener('click', cancelNewOrder);

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–æ–ª—è—Ö –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            ['newIsin', 'newPrice', 'newFeePercent'].forEach(id => {
                document.getElementById(id).addEventListener('input', validateNewOrderForm);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±–ª–∏–≥–∞—Ü–∏–π –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        async function loadAvailableBonds() {
            try {
                const response = await fetch('/api/orders/bonds');
                if (response.ok) {
                    availableBonds = await response.json();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±–ª–∏–≥–∞—Ü–∏–π:', error);
            }
        }

        // –í—ã–±–æ—Ä –æ–±–ª–∏–≥–∞—Ü–∏–∏ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function selectBond(isin) {
            const bond = availableBonds.find(b => b.isin === isin);
            if (!bond) return;

            document.getElementById('newIsin').value = bond.isin;
            document.getElementById('newBondName').textContent = bond.brandName || bond.shortName || '-';
            document.getElementById('newRating').textContent = bond.ratingValue || '-';
            document.getElementById('newCouponValue').textContent = bond.couponValue ? formatCurrency(bond.couponValue) : '-';
            document.getElementById('newCouponPeriod').textContent = bond.couponLength ? bond.couponLength + ' –¥–Ω.' : '-';
            document.getElementById('newFaceValue').textContent = bond.faceValue ? formatCurrency(bond.faceValue) : '-';
            document.getElementById('newNkd').textContent = bond.nkd ? formatCurrency(bond.nkd) : '-';
            
            if (bond.priceAsk) {
                document.getElementById('newPrice').value = bond.priceAsk;
            }

            document.getElementById('isinDropdown').style.display = 'none';
            validateNewOrderForm();
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
        function validateNewOrderForm() {
            const isin = document.getElementById('newIsin').value;
            const price = document.getElementById('newPrice').value;
            const feePercent = document.getElementById('newFeePercent').value;
            
            const isValid = isin && price && feePercent !== '';
            document.getElementById('saveNewOrderBtn').disabled = !isValid;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
        async function saveNewOrder() {
            const errorDiv = document.getElementById('addOrderError');
            errorDiv.style.display = 'none';

            const orderData = {
                purchaseDate: document.getElementById('newPurchaseDate').value,
                isin: document.getElementById('newIsin').value,
                priceAsk: parseFloat(document.getElementById('newPrice').value),
                feePercent: parseFloat(document.getElementById('newFeePercent').value)
            };

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–¥–µ–ª–∫–∏';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // –û—Ç–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å–¥–µ–ª–∫–∏
        function cancelNewOrder() {
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('newPurchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('newIsin').value = '';
            document.getElementById('newPrice').value = '';
            document.getElementById('newFeePercent').value = '0.3';
            
            // –û—á–∏—â–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
            ['newBondName', 'newRating', 'newCouponValue', 'newCouponPeriod', 'newFaceValue', 'newNkd',
             'newTotalCosts', 'newTotalCoupon', 'newTotalIncome', 'newNetProfit', 'newAnnualYield'].forEach(id => {
                document.getElementById(id).textContent = '-';
            });

            document.getElementById('addOrderError').style.display = 'none';
            document.getElementById('saveNewOrderBtn').disabled = true;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏
        async function deleteOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    document.getElementById(`order-row-${orderId}`).remove();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Å–¥–µ–ª–∫–∏
                    const remainingRows = document.querySelectorAll('.order-row');
                    if (remainingRows.length === 0) {
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    }
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
        function formatCurrency(value) {
            if (value == null) return '-';
            return parseFloat(value).toFixed(2);
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        function formatPercentage(value) {
            if (value == null) return '-';
            return parseFloat(value).toFixed(2);
        }

        // Inline —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π —Å–¥–µ–ª–∫–∏
        function editOrderField(orderId, fieldName) {
            const row = document.getElementById(`order-row-${orderId}`);
            if (row.classList.contains('editing')) return; // –£–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

            row.classList.add('editing');
            
            // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            let cellIndex;
            let currentValue;
            
            switch (fieldName) {
                case 'purchaseDate':
                    cellIndex = 0;
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º DD.MM.YYYY –≤ YYYY-MM-DD –¥–ª—è input[type="date"]
                    const dateText = row.cells[cellIndex].textContent.trim();
                    const dateParts = dateText.split('.');
                    if (dateParts.length === 3) {
                        currentValue = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    } else {
                        currentValue = '';
                    }
                    break;
                case 'priceAsk':
                    cellIndex = 6;
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É/–∑–∞–ø—è—Ç—É—é
                    const priceText = row.cells[cellIndex].textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                    currentValue = priceText || '';
                    break;
                case 'feePercent':
                    cellIndex = 8;
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫—É/–∑–∞–ø—è—Ç—É—é
                    const feeText = row.cells[cellIndex].textContent.replace(/[^\d.,]/g, '').replace(',', '.');
                    currentValue = feeText || '';
                    break;
                default:
                    return;
            }
            
            console.log(`–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø–æ–ª–µ ${fieldName}, —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: "${currentValue}"`);

            const cell = row.cells[cellIndex];
            const originalContent = cell.innerHTML;

            // –°–æ–∑–¥–∞–µ–º input –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            let inputType = fieldName === 'purchaseDate' ? 'date' : 'number';
            let inputStep = fieldName === 'purchaseDate' ? '' : 'step="0.01"';
            
            cell.innerHTML = `
                <input type="${inputType}" value="${currentValue}" ${inputStep} class="edit-input" 
                       onblur="saveOrderField(${orderId}, '${fieldName}', this.value, '${originalContent.replace(/'/g, "\\'")}')"
                       onkeydown="handleOrderFieldKeydown(event, ${orderId}, '${fieldName}', '${originalContent.replace(/'/g, "\\'")}')" />
            `;
            
            cell.querySelector('input').focus();
            cell.querySelector('input').select();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—è
        async function saveOrderField(orderId, fieldName, newValue, originalContent) {
            console.log(`saveOrderField –≤—ã–∑–≤–∞–Ω: orderId=${orderId}, fieldName=${fieldName}, newValue="${newValue}"`);
            
            if (!newValue || newValue.trim() === '') {
                console.log('–ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ—Ç–º–µ–Ω—è–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
                cancelOrderFieldEdit(orderId, fieldName, originalContent);
                return;
            }

            const updateData = {};
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—è
            if (fieldName === 'purchaseDate') {
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã:', newValue);
                updateData.purchaseDate = newValue;
            } else if (fieldName === 'priceAsk') {
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–µ–Ω—ã:', newValue);
                const priceValue = parseFloat(newValue);
                console.log('–ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω—ã:', priceValue);
                if (isNaN(priceValue) || priceValue <= 0) {
                    alert('–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
                    cancelOrderFieldEdit(orderId, fieldName, originalContent);
                    return;
                }
                updateData.priceAsk = priceValue;
            } else if (fieldName === 'feePercent') {
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏:', newValue);
                const feeValue = parseFloat(newValue);
                console.log('–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∏—Å—Å–∏–∏:', feeValue);
                if (isNaN(feeValue) || feeValue < 0) {
                    alert('–ö–æ–º–∏—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º');
                    cancelOrderFieldEdit(orderId, fieldName, originalContent);
                    return;
                }
                updateData.feePercent = feeValue;
            }

            console.log('–§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', JSON.stringify(updateData));

            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    cancelOrderFieldEdit(orderId, fieldName, originalContent);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                cancelOrderFieldEdit(orderId, fieldName, originalContent);
            }
        }

        // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—è
        function cancelOrderFieldEdit(orderId, fieldName, originalContent) {
            const row = document.getElementById(`order-row-${orderId}`);
            let cellIndex;
            
            switch (fieldName) {
                case 'purchaseDate':
                    cellIndex = 0;
                    break;
                case 'priceAsk':
                    cellIndex = 6;
                    break;
                case 'feePercent':
                    cellIndex = 8;
                    break;
                default:
                    return;
            }

            row.cells[cellIndex].innerHTML = originalContent;
            row.classList.remove('editing');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        function handleOrderFieldKeydown(event, orderId, fieldName, originalContent) {
            if (event.key === 'Enter') {
                event.target.blur(); // –ó–∞–ø—É—Å–∫–∞–µ—Ç onblur -> saveOrderField
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelOrderFieldEdit(orderId, fieldName, originalContent);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–π —Å–¥–µ–ª–∫–∏ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ alert)
        function editOrder(orderId) {
            alert('–ü–æ–ª–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏. –°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ –∫–ª–∏–∫—É.');
        }
    </script>
</body>
</html>