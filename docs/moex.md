# Модуль MOEX - Московская биржа

## Назначение модуля

Получение базовых данных об облигациях с официального сайта Московской биржи в формате CSV.

## Функциональность

### Источники данных
- **Основной источник**: CSV-файл по HTTP-ссылке (кодировка CP1251)

### Процесс обработки
1. **Загрузка файла** по ссылке
2. **Динамический поиск заголовков** в CSV (может быть не в первой строке)
3. **Автоматическое определение колонок** по названиям заголовков
4. **Парсинг данных** с валидацией и обработкой ошибок
5. **Сохранение в БД** в таблицу `moex_bonds`
6. **Парсинг только облигаций в рублях**: колонка FACEUNIT должна содержать значение RUB

### Поддерживаемые колонки CSV

| Название в CSV   | Описание                        | Поле в БД          | Обязательное |
|------------------|---------------------------------|--------------------|--------------|
| ISIN             | Уникальный код облигации        | isin               | ✓            |
| SHORTNAME        | Краткое название облигации      | short_name         | ✓            |
| COUPONVALUE      | Размер купонного платежа        | coupon_value       | ✓            |
| MATDATE          | Дата погашения облигации        | maturity_date      | ✓            |
| FACEVALUE        | Номинальная стоимость           | face_value         | ✓            |
| COUPONFREQUENCY  | Количество купонов в год        | coupon_frequency   | ✓            |
| COUPONLENGTH     | Длительность купонного периода  | coupon_length      | ✓            |
| COUPONDAYSPASSED | Дней прошло с последнего купона | coupon_days_passed | ✓            |
| OFFERDATE        | Дата оферты                     | offer_date         | ✓            |

## API

### Endpoints
- `POST /api/moex/bonds/parse` - запуск парсинга вручную

### Автоматизация
- **Периодичность**: настраивается через cron-выражение
- **Конфигурация**: `moex.cron`

## Конфигурация

```yaml
moex:
  csv-url: "https://..."       # URL CSV-файла биржи
  cron: "0 0 11 * * MON-FRI"    # ежедневно в 11:00 по будням
```

В коде не должно быть никаких значений конфигурации по умолчанию.

## Логирование

### Уровень DEBUG
- Результат парсинга каждой строки
- Детали валидации данных
- Ошибки конвертации типов

### Уровень INFO
- Начало/окончание процесса парсинга
- Сводная статистика: всего обработано, успешно, с ошибками
- Источник данных (URL или файл)

### Уровень ERROR
- Критические ошибки загрузки
- Проблемы с форматом CSV
- Ошибки подключения к БД

## Обработка ошибок

### Стратегия восстановления
1. **Ошибки парсинга строки**: пропуск строки, продолжение обработки
2. **Ошибки БД**: логирование, повторная попытка для следующей строки

### Валидация данных
- **ISIN**: проверка формата и уникальности
- **Даты**: валидация формата и логичности
- **Числовые поля**: проверка на корректность и разумные диапазоны
- **Размер купона**: если не задан, то это логируется и облигация не сохраняется в БД
- **Количество купонов в год**: если не задана, то это логируется и облигация не сохраняется в БД
- **Дней прошло с последнего купона**: если не задана, то это логируется и облигация не сохраняется в БД
- **Дата погашения облигации**: если не задана, то это логируется и облигация не сохраняется в БД

## Технические детали

### Библиотеки
- **OpenCSV** для парсинга CSV-файлов
- **Hibernate** для работы с БД
- **Spring Web** для HTTP-запросов
