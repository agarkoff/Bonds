# Анализ парсинга данных облигаций

## Общая схема таблицы bonds

Таблица `bonds` содержит следующие основные группы колонок:

### Основные данные облигации
- `id` - автоинкрементный первичный ключ
- `isin` - уникальный международный идентификатор (первичный источник: MOEX)
- `ticker` - тикер облигации
- `short_name` - краткое наименование
- `created_at`, `updated_at` - временные метки

### Купонные данные
- `coupon_value` - размер купона
- `coupon_frequency` - частота выплат купона
- `coupon_length` - длительность купонного периода в днях
- `coupon_days_passed` - количество дней с начала периода
- `maturity_date` - дата погашения
- `face_value` - номинальная стоимость
- `offer_date` - дата оферты (опционально)

### T-Bank данные
- `figi` - Financial Instrument Global Identifier
- `instrument_uid` - уникальный идентификатор инструмента
- `asset_uid` - идентификатор базового актива
- `brand_name` - наименование бренда/эмитента

### Рыночные данные
- `price` - текущая рыночная цена

### Рейтинги
- `rating_value` - текстовое значение рейтинга
- `rating_code` - числовой код рейтинга

### Расчетные показатели
- `coupon_daily` - дневной купон
- `nkd` - накопленный купонный доход
- `costs` - общие затраты на покупку
- `fee` - комиссия брокера
- `coupon_redemption` - сумма купонов до погашения
- `profit` - прибыль до налогов
- `profit_net` - чистая прибыль после налогов
- `annual_yield` - годовая доходность

### Данные по оферте
- `coupon_offer` - купон по оферте
- `profit_offer` - прибыль по оферте
- `profit_net_offer` - чистая прибыль по оферте
- `annual_yield_offer` - годовая доходность по оферте

---

## Анализ заполнения данных по сервисам

### 1. MoexService (Московская биржа)
**Файл:** `MoexService.java`  
**Источник данных:** CSV файл с сайта MOEX или fallback файл  
**Расписание:** Ежедневно в 11:00 по рабочим дням  

**Заполняемые колонки:**
- ✅ `isin` - основной идентификатор (из SECID)
- ✅ `ticker` - дублирует ISIN
- ✅ `short_name` - из SHORTNAME
- ✅ `coupon_value` - из COUPONVALUE (размер купона)
- ✅ `face_value` - из FACEVALUE (номинал)
- ✅ `coupon_frequency` - из COUPONFREQUENCY
- ✅ `coupon_length` - из COUPONLENGTH
- ✅ `coupon_days_passed` - из COUPONDAYSPASSED
- ✅ `maturity_date` - из MATDATE (формат dd.MM.yyyy)
- ✅ `offer_date` - из OFFERDATE (формат dd.MM.yyyy)

**Особенности:**
- Основной источник базовых данных об облигациях
- Создает новые записи облигаций, если их нет в базе
- Использует ISIN как уникальный идентификатор

---

### 2. TBankInstrumentsService (Т-Банк инструменты)
**Файл:** `TBankInstrumentsService.java`  
**Источник данных:** T-Bank Invest API  
**Расписание:** Ежедневно в 02:00  

**Заполняемые колонки:**
- ✅ `figi` - из API поля figi
- ✅ `instrument_uid` - из API поля uid
- ✅ `asset_uid` - из API поля assetUid
- ✅ `brand_name` - получается через дополнительный запрос GetBrandBy

**Особенности:**
- Обогащает существующие записи облигаций данными T-Bank
- Может создавать новые записи, если находит облигации отсутствующие в базе
- Использует ticker из API для поиска соответствия с ISIN

---

### 3. TBankMarketDataService (Т-Банк рыночные данные)
**Файл:** `TBankMarketDataService.java`  
**Источник данных:** T-Bank Market Data API  
**Расписание:** Каждые 15 минут с 09:00 до 18:00 по рабочим дням  

**Заполняемые колонки:**
- ✅ `price` - текущая рыночная цена

**Особенности:**
- Обновляет только цены существующих облигаций
- Работает только с облигациями, у которых есть FIGI
- Получает только реальные рыночные цены через T-Bank API
- Использует метод `bondRepository.updatePrice()` для обновления

---

### 4. CalculationService (Расчетный сервис)
**Файл:** `CalculationService.java`  
**Источник данных:** Вычисления на основе имеющихся данных  
**Расписание:** Каждые 30 минут  

**Заполняемые колонки:**
- ✅ `coupon_daily` - дневной купон (coupon_value / coupon_length)
- ✅ `nkd` - НКД (coupon_daily × (coupon_days_passed + 1))
- ✅ `fee` - комиссия брокера ((price + nkd) × broker_fee%)
- ✅ `costs` - общие затраты (price + nkd + fee)
- ✅ `coupon_redemption` - сумма купонов до погашения
- ✅ `profit` - прибыль до налогов (face_value + coupon_redemption - costs)
- ✅ `profit_net` - чистая прибыль (profit × (1 - ndfl%))
- ✅ `annual_yield` - годовая доходность (profit_net / costs × 365 / days_to_maturity × 100)
- ✅ `coupon_offer` - купон по оферте (если есть offer_date)
- ✅ `profit_offer` - прибыль по оферте
- ✅ `profit_net_offer` - чистая прибыль по оферте
- ✅ `annual_yield_offer` - годовая доходность по оферте

**Особенности:**
- Работает только с облигациями, имеющими необходимые исходные данные
- Может делать расчеты с кастомной комиссией
- Использует конфигурацию из CalcConfig (комиссия брокера, НДФЛ, точность)

---

### 5. RaExpertService + Rating (Рейтинговое агентство)
**Файлы:** `RaExpertService.java`, `Rating.java`  
**Источник данных:** Веб-скрапинг сайта raexpert.ru  
**Расписание:** Еженедельно по воскресеньям в 02:00  

**Заполняемые колонки в таблице bonds:**
- ⚠️ `rating_value` - **КОНФЛИКТ С DohodService**
- ⚠️ `rating_code` - **КОНФЛИКТ С DohodService**

**Заполняемые колонки в таблице ratings:**
- ✅ `isin` - связь с облигацией
- ✅ `company_name` - название эмитента
- ✅ `rating_value` - текстовое значение рейтинга
- ✅ `rating_code` - числовой код рейтинга
- ✅ `rating_date` - дата присвоения рейтинга

**Особенности:**
- Использует кэширование загруженных страниц (60 дней)
- Парсит HTML страницы для извлечения ISIN и данных рейтинга
- Сохраняет исторические данные рейтингов в отдельную таблицу

---

### 6. DohodService (Dohod.ru рейтинги)
**Файл:** `DohodService.java`  
**Источник данных:** Веб-скрапинг сайта dohod.ru  
**Расписание:** Управляется конфигурацией DohodConfig  

**Заполняемые колонки в таблице bonds:**
- ⚠️ `rating_value` - **КОНФЛИКТ С RaExpertService**
- ⚠️ `rating_code` - **КОНФЛИКТ С RaExpertService**

**Заполняемые колонки в таблице ratings:**
- ✅ `isin` - связь с облигацией
- ✅ `rating_value` - текстовое значение рейтинга с префиксом "ru"
- ✅ `rating_code` - числовой код рейтинга
- ✅ `rating_date` - дата обновления (текущая дата)

**Особенности:**
- Использует Selenium WebDriver для навигации по страницам
- Добавляет префикс "ru" к извлекаемым рейтингам
- Обрабатывает пагинацию для полного покрытия данных
- Извлекает ISIN из атрибута `data-open-isin` HTML элементов
- Использует RatingUtils для валидации и конвертации рейтингов
- Поддерживает автоматическое согласие с cookie-баннером

---

## ⚠️ Потенциальные конфликты данных

### 1. Рейтинговые поля в таблице bonds
**Проблемные колонки:** `rating_value`, `rating_code`

**Потенциальные источники:**
- RaExpertService
- DohodService  
- Возможно, другие рейтинговые агентства в будущем

**Рекомендации:**
- Определить приоритет источников рейтингов
- Рассмотреть добавление поля `rating_source` для отслеживания источника
- Реализовать стратегию разрешения конфликтов (последний актуальный, наивысший рейтинг, и т.д.)

### 2. Данные эмитента
**Потенциально конфликтующие поля:** `brand_name` vs данные из других источников

**Источники:**
- TBankInstrumentsService (через GetBrandBy API)
- Потенциально MOEX (через short_name)
- Потенциально RaExpert (через company_name)

### 3. Основные данные облигации
**Пересекающиеся поля:** базовые данные могут поступать из разных источников

**Текущая стратегия:**
- MOEX является первичным источником
- T-Bank дополняет и может создавать новые записи
- Остальные сервисы только обогащают данные

---

## 📊 Зависимости между сервисами

```
MoexService (базовые данные)
    ↓
TBankInstrumentsService (обогащение T-Bank данными)
    ↓
TBankMarketDataService (цены) → CalculationService (расчеты)
    ↓
RaExpertService (рейтинги) + DohodService (рейтинги)
```

**Критические зависимости:**
1. CalculationService требует данные от MoexService и TBankMarketDataService
2. TBankMarketDataService работает только с облигациями, имеющими FIGI
3. Все сервисы используют ISIN как основной идентификатор

---

## 🔄 Рекомендации по улучшению

1. **Добавить поле `data_source`** для отслеживания источника каждого поля
2. **Реализовать стратегию разрешения конфликтов** для перекрывающихся данных
3. **Добавить валидацию данных** между сервисами
4. **Рассмотреть версионирование данных** для исторического анализа
5. **Добавить мониторинг качества данных** и отчетности о пропущенных полях