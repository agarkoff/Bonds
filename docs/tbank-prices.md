# Модуль T-Bank Market Data

## Назначение модуля

Получение актуальных рыночных цен облигаций через API Тинькофф Банка для расчета показателей доходности.

## Функциональность

### Основные операции
1. **Получение цен по FIGI** - запрос лучшей цены покупки из биржевого стакана
2. **Массовое обновление** - получение цен для всех облигаций в БД
3. **Ограничения по времени** - получение цен только в рыночные часы

### Алгоритм работы

#### Рыночные часы (09:50 - 18:50)
1. **Получение FIGI** из таблицы `tbank_bonds`
2. **Запрос стакана** через API T-Bank
3. **Извлечение лучшей цены** из ask-части стакана
4. **Обновление цены** в БД в таблице `tbank_prices`

### Структура данных

#### Колонки таблицы tbank_prices
| Поле API | Поле БД | Описание                   |
|----------|---------|----------------------------|
| figi     | figi    | Идентификатор для торговли |
| price    | price   | Цена в рублях              |

#### Внерыночные часы (18:50 - 09:50)
1. **Пропуск обновления** - цены не обновляются вне торговых часов
2. **Сохранение данных** - предыдущие цены остаются без изменений

## API

### Endpoints
- `POST /api/tbank/prices/parse` - запуск обновления цен вручную

### Автоматизация
- **Периодичность**: настраивается через cron-выражение
- **Конфигурация**: `tbank.prices.cron`
- **Рекомендуемая частота**: каждые 5 минут в торговые часы

## Конфигурация

```yaml
tbank:
  api-url: "https://invest-public-api.tinkoff.ru/rest"
  token: "${TBANK_TOKEN}"            # токен из переменной окружения
  rate-limit: 300                    # запросов в минуту
  prices:
    cron: "0 */10 9-18 * * MON-FRI"  # каждые 10 минут в торговые часы
```

В коде не должно быть никаких значений конфигурации по умолчанию.

## Обработка данных

### Структура стакана
```json
{
  "figi": "BBG00Y91R9T3",
  "asks": [
    {
      "price": {"units": "1050", "nano": "500000000"},
      "quantity": "10"
    }
  ]
}
```

### Конвертация цен
- **Units**: целая часть цены в процентах от номинала
- **Nano**: дробная часть в наносекундах (дополнительная точность)
- **Цена в процентах**: units + nano/1,000,000,000
- **Абсолютная цена**: (цена_в_процентах × номинал) / 100
- Для определения номинальной стоимости при расчёте цену в парсинге рыночных данных нужно использовать moex_bonds.face_value.
  Если данных нет в moex_bonds, то цены таких облигаций не должны скачиваться, но такая ситуация должна логироваться.

#### Пример расчета:
```
Units: 105, Nano: 500000000, Номинал: 1000 RUB
Цена в процентах: 105 + 500000000/1000000000 = 105.5%
Абсолютная цена: (105.5 × 1000) / 100 = 1055 RUB
```

### Валидация
- **FIGI**: проверка корректности идентификатора
- **Цена**: проверка на разумность (0.1-200% от номинала)
- **Время**: валидация торговых часов

## Логирование

### Уровень DEBUG
- Детали каждого запроса стакана
- Результаты обработки отдельных облигаций
- Информация о пропущенных обновлениях

### Уровень INFO
- Начало/окончание массового обновления
- Статистика: всего обработано, успешно, с ошибками
- Количество облигаций без доступных цен

### Уровень ERROR
- Ошибки API-запросов
- Проблемы с авторизацией
- Некорректные данные стакана

## Обработка ошибок

### Стратегии восстановления
1. **Пустой стакан**: пропуск обновления цены
2. **API недоступен**: пропуск итерации, логирование
3. **Некорректные данные**: пропуск обновления цены

### Rate Limiting
- **Ограничение**: 300 запросов в минуту
- **Задержка**: автоматическая между запросами
- **Overflow**: очередь запросов с приоритетом

## Особенности реализации

### Временные зоны
- **Торговые часы**: 09:50-18:50 (МСК)
- **Выходные дни**: суббота, воскресенье
- **Праздники**: учет российских торговых календарей
