# Модуль RaExpert - Рейтинговое агентство

## Назначение модуля

Автоматизированный парсинг кредитных рейтингов облигаций с официального сайта рейтингового агентства RaExpert.

## Функциональность

### Источник данных
- **Базовый URL**: https://raexpert.ru/ratings/debt_inst/
- **Технология**: Headless браузер с поддержкой JavaScript
- **Пагинация**: Автоматический переход по страницам

### Алгоритм парсинга

#### Этап 1: Обход списка облигаций
1. **Загрузка главной страницы** рейтингов долговых инструментов
2. **Поиск ссылок на облигации** в блоке `div.b-actions__rates`
3. **Поиск ссылок на облигации в колонке "Эмиссия"** - только из тела таблицы (`tbody`)
4. **Переход между страницами** через `div.b-paginator`

#### Этап 2: Парсинг страницы облигации
1. **Извлечение ISIN** из блока `div.b-title` с текстом "Реквизиты"
2. **Получение названия эмитента** из блока `div.b-title` с текстом "Эмитент"
3. **Парсинг таблицы рейтингов** `table.object-rating-table`
4. **Фильтрация по национальной шкале** - только записи с "Национальная шкала"

### Кэширование
- **Локальное сохранение**: каждая страница сохраняется в файл
- **Проверка актуальности**: файлы старше заданного срока обновляются
- **Структура имен**: URL преобразуется в безопасное имя файла

## Структура рейтинговых данных

### Таблица `ratings`
| Поле БД      | Источник данных    | Описание                       |
|--------------|--------------------|--------------------------------|
| isin         | Блок "Реквизиты"   | Идентификатор облигации        |
| company_name | Блок "Эмитент"     | Название компании-эмитента     |
| rating_value | Колонка "Рейтинг"  | Буквенное обозначение рейтинга |
| rating_code  | Расчетное (мапинг) | Численный код для сортировки   |
| rating_date  | Колонка "Дата"     | Дата присвоения рейтинга       |

### Поддерживаемые рейтинги

Национальная шкала (по убыванию качества):
- **ruAAA** (код 48) - Высший уровень надежности
- **ruAA+, ruAA, ruAA-** (коды 49-51) - Очень высокий уровень
- **ruA+, ruA, ruA-** (коды 52-54) - Высокий уровень
- **ruBBB+, ruBBB, ruBBB-** (коды 146-148) - Средний уровень
- **ruBB+, ruBB, ruBB-** (коды 149-151) - Умеренный уровень
- **ruB+, ruB, ruB-** (коды 152-154) - Высокий риск
- **ruCCC, ruCC, ruC** (коды 249-251) - Очень высокий риск
- **ruRD, ruD** (коды 252-253) - Дефолт

## API

### Endpoints
- `POST /api/ratings/update` - запуск парсинга рейтингов вручную

### Автоматизация
- **Периодичность**: настраивается через cron-выражение
- **Конфигурация**: `raexpert.cron`
- **Рекомендуемая частота**: еженедельно

## Конфигурация

```yaml
raexpert:
  cron: "0 0 2 * * SUN"          # еженедельно по воскресеньям в 2:00
  cache:
    path: "cache/raexpert"       # каталог для кэширования страниц
    expires-days: 7              # срок жизни кэша в днях
  delays:
    page-interval: 30            # задержка между страницами в секундах
    request-timeout: 30          # таймаут HTTP-запросов в секундах
```

## Обработка данных

### Валидация
- **ISIN**: проверка формата (12 символов)
- **Дата**: валидация формата и разумности
- **Рейтинг**: соответствие поддерживаемым значениям

### Дедупликация
- **Проверка существования**: избежание дублирования записей
- **Условие уникальности**: ISIN + дата рейтинга

### Связывание данных
- **Поиск облигации**: по полю ISIN в таблице `bonds`
- **Обновление рейтинга**: актуализация текущего рейтинга в `bonds`

## Технические особенности

### Selenium WebDriver
- **Headless режим**: работа без графического интерфейса
- **Chrome опции**: оптимизация для серверной среды
- **Обработка JavaScript**: полная поддержка динамического контента

### Обработка ошибок
- **Сетевые ошибки**: повторные попытки с экспоненциальной задержкой
- **Парсинг**: пропуск некорректных записей с логированием
- **Rate limiting**: соблюдение ограничений сайта

## Логирование

### Уровень DEBUG
- Детали парсинга каждой страницы
- Результаты извлечения данных
- Использование кэша

### Уровень INFO
- Начало/окончание процесса парсинга
- Статистика по страницам и рейтингам
- Общие результаты обработки

### Уровень ERROR
- Критические ошибки парсинга
- Проблемы с WebDriver
- Недоступность сайта

## Производительность

### Оптимизация
- **Кэширование страниц**: снижение нагрузки на сайт
- **Пакетная обработка**: группированное сохранение в БД
- **Параллельная обработка**: многопоточный парсинг при возможности

### Ограничения
- **Интервалы запросов**: минимум 30 секунд между страницами
- **Размер кэша**: автоматическая очистка устаревших файлов
- **Мониторинг**: отслеживание времени выполнения

## Интеграция

### Зависимости
- **Bonds**: основная таблица для связывания данных
- **WebDriver**: требует настроенный Chrome/Chromium

### Потребители
- **Calculation**: использует рейтинги для аналитики
- **Web Interface**: отображение рейтинговой информации
- **Reporting**: включение в отчеты и фильтрацию

## Мониторинг

### Метрики
- **Время парсинга**: общее время выполнения
- **Количество страниц**: обработано/пропущено
- **Успешность**: процент успешно обработанных рейтингов

### Алерты
- **Недоступность сайта**: уведомления о проблемах доступа
- **Критические ошибки**: оповещения о сбоях парсинга
- **Устаревшие данные**: предупреждения о долгом отсутствии обновлений