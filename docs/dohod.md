# Модуль Dohod

## Назначение модуля

Автоматизированный парсинг кредитных рейтингов облигаций с официального сайта Dohod.

## Функциональность

### Источник данных
- **Базовый URL**: https://www.dohod.ru/analytic/bonds
- **Технология**: Headless браузер с поддержкой JavaScript
- **Пагинация**: Автоматический переход по страницам

### Алгоритм парсинга

#### Обход списка облигаций
1. **Загрузка главной страницы** рейтингов долговых инструментов
2. **Согласиться с cookies** нажав кнопку Согласен с CSS-селектором "span.cookiemsg__bottom_close" 
3. **Обработка строк таблицы** по CSS-селектору "tr.bonds__item"
4. **Определение ISIN** по значению атрибута data-open-isin в ячейке с CSS-селектором "td.shortname"
5. **Определение рейтинга** из тега span внутри ячейки с CSS-селектором "td.credit_rating_text"
6. **Переход на следующую страницу** обеспечивается по ссылке следующей за ссылкой с CSS-селектором "a.paginate_button.current"

#### Кеширования нет

## API

### Endpoints
- `POST /api/ratings/dohod/update` - запуск парсинга рейтингов вручную

### Автоматизация
- **Периодичность**: настраивается через cron-выражение
- **Конфигурация**: `raexpert.cron`
- **Рекомендуемая частота**: еженедельно

## Конфигурация

```yaml
dohod:
  cron: "0 0 2 * * SUN"          # еженедельно по воскресеньям в 2:00
  delays:
    page-interval: 30            # задержка между страницами в секундах
    request-timeout: 30          # таймаут HTTP-запросов в секундах
```

В коде не должно быть никаких значений конфигурации по умолчанию.

## Обработка данных

### Валидация
- **ISIN**: проверка формата (12 символов)
- **Рейтинг**: соответствие поддерживаемым значениям

### Дедупликация
- **Проверка существования**: избежание дублирования записей
- **Условие уникальности**: ISIN

### Связывание данных
- **Поиск облигации**: по полю ISIN в таблице `bonds`
- **Обновление рейтинга**: актуализация текущего рейтинга в `bonds`

## Технические особенности

### Selenium WebDriver
- **Headless режим**: работа без графического интерфейса
- **Chrome опции**: оптимизация для серверной среды
- **Обработка JavaScript**: полная поддержка динамического контента

### Обработка ошибок
- **Сетевые ошибки**: повторные попытки с экспоненциальной задержкой
- **Парсинг**: пропуск некорректных записей с логированием
- **Rate limiting**: соблюдение ограничений сайта

## Логирование

### Уровень DEBUG
- Детали парсинга каждой страницы
- Результаты извлечения данных

### Уровень INFO
- Начало/окончание процесса парсинга
- Статистика по страницам и рейтингам
- Общие результаты обработки

### Уровень ERROR
- Критические ошибки парсинга
- Проблемы с WebDriver
- Недоступность сайта

## Производительность

### Ограничения
- **Интервалы запросов**: минимум 30 секунд между страницами
- **Размер кэша**: автоматическая очистка устаревших файлов
- **Мониторинг**: отслеживание времени выполнения

## Интеграция

### Зависимости
- **Bonds**: основная таблица для связывания данных
- **WebDriver**: требует настроенный Chrome/Chromium

### Потребители
- **Calculation**: использует рейтинги для аналитики
- **Web Interface**: отображение рейтинговой информации
- **Reporting**: включение в отчеты и фильтрацию

## Мониторинг

### Метрики
- **Время парсинга**: общее время выполнения
- **Количество страниц**: обработано/пропущено
- **Успешность**: процент успешно обработанных рейтингов

### Алерты
- **Недоступность сайта**: уведомления о проблемах доступа
- **Критические ошибки**: оповещения о сбоях парсинга
- **Устаревшие данные**: предупреждения о долгом отсутствии обновлений
