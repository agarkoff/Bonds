# Модуль T-Bank Instruments

## Назначение модуля

Получение информации об активах и инструментах (облигациях) через официальный API Тинькофф Банка и обогащение данных в таблице `bonds`.

## Функциональность

### Основные операции
1. **Загрузка всех инструментов** - получение списка всех доступных облигаций
2. **Загрузка активов** - получение информации об эмитентах
3. **Обогащение данных брендом** - получение названий компаний-эмитентов с помощью метода GetBrandBy.
   Для этого нужно получить полную информацию об asset методом GetAssetBy и достать идентификатор бренда.
4. **Обновление БД** - сохранение данных в таблицу `bonds` по полю `isin`

### Поток данных
```
T-Bank API → Assets → Brand Info → Instruments → bonds table
```

### Структура данных

#### Поля активов (эмитентов)
| Поле API   | Поле БД    | Описание                   |
|------------|------------|----------------------------|
| uid        | asset_uid  | Уникальный ID актива       |
| brand.name | brand_name | Название компании-эмитента |

#### Поля инструментов (облигаций)
| Поле API       | Поле БД         | Описание                     |
|----------------|-----------------|------------------------------|
| uid            | instrument_uid  | Уникальный ID инструмента    |
| figi           | figi            | Идентификатор для торговли   |
| ticker         | ticker          | Торговый код (= isin)        |



## API

### Endpoints
- `POST /api/tbank/bonds/update` - запуск обновления данных вручную

### Автоматизация
- **Периодичность**: настраивается через cron-выражение
- **Конфигурация**: `tbank.instruments.cron`

## Конфигурация

```yaml
tbank:
  api-url: "https://invest-public-api.tinkoff.ru/rest"
  token: "${TBANK_TOKEN}"        # токен из переменной окружения
  rate-limit: 60                 # запросов в минуту
  instruments:
    cron: "0 0 2 * * *"         # ежедневно в 2:00
```

## Логирование

### Уровень DEBUG
- Детали каждого API-запроса
- Обработка отдельных инструментов и активов
- Результаты обогащения данных

### Уровень INFO
- Начало/окончание загрузки
- Статистика: загружено инструментов, активов, обогащено записей
- Обнаруженные расхождения в данных

### Уровень ERROR
- Ошибки API-запросов
- Проблемы с авторизацией
- Критические ошибки обработки

## Обработка данных

### Стратегия обновления
1. **Сравнение с существующими данными** в БД
2. **Логирование расхождений** при обнаружении отличий
3. **Обновление только изменившихся полей**
4. **Создание новых записей** для новых инструментов

### Валидация
- **Токен API**: проверка наличия и корректности
- **Rate limiting**: контроль частоты запросов
- **Обязательные поля**: проверка наличия ключевых данных

## Технические детали

### Безопасность
- **API Token**: хранение в переменных окружения
- **Rate Limiting**: встроенное ограничение запросов
- **Retry Logic**: повторные попытки при временных ошибках

### Производительность
- **Batch processing**: группированная обработка данных
- **Минимальные запросы**: оптимизация количества вызовов API
- **Асинхронная обработка**: неблокирующие операции

### Мониторинг
- **Метрики запросов**: количество успешных/неуспешных вызовов
- **Время выполнения**: отслеживание производительности
- **Статус API**: проверка доступности внешнего сервиса

## Интеграция с другими модулями

### Зависимости
- **Market Data**: использует FIGI для получения цен
- **Calculation**: обогащает данные для расчетов
- **Web Interface**: предоставляет названия компаний

### Синхронизация
- **Приоритет выполнения**: запускается перед Market Data
- **Консистентность данных**: обеспечивает актуальность ссылок
- **Rollback**: возможность отката при критических ошибках