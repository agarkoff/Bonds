# Модуль расчета доходности

## Назначение модуля

Расчет ключевых показателей доходности облигаций на основе рыночных данных и характеристик инструментов.

## Рассчитываемые показатели

### Таблица показателей

Рассчитанные показатели сохраняются в таблице `bonds_calc` 

| Показатель          | Поле БД           | Формула расчета                                     | Описание                               |
|---------------------|-------------------|-----------------------------------------------------|----------------------------------------|
| Дневной купон       | coupon_daily      | `coupon_value / coupon_length`                      | Ежедневное начисление купонного дохода |
| НКД                 | nkd               | `(coupon_days_passed + 1) × coupon_daily`           | Накопленный купонный доход             |
| Затраты             | costs             | `price + nkd`                                       | Общие затраты на покупку               |
| Купоны до погашения | coupon_redemption | `(maturity_date - now() - 1) × coupon_daily + nkd`  | Доход от купонов до погашения          |
| Доход               | profit            | `face_value + coupon_redemption - costs`            | Валовый доход от инвестиции            |
| Чистая прибыль      | profit_net        | `profit × (1 - ndfl_percent / 100)`                 | Доход после уплаты налогов             |
| Годовая доходность  | annual_yield      | `profit_net / costs × 365 / days_to_maturity × 100` | Годовая доходность в процентах         |

### Параметры расчета

Конфигурируются в файле настроек:
- **broker.ndfl** - ставка подоходного налога (в процентах)
- **bonds.calc-interval** - интервал пересчета (в минутах)

## Функциональность

### Основные операции
1. **Индивидуальный расчет** - для конкретной облигации по ISIN
2. **Массовый расчет** - для всех облигаций в БД
3. **Валидация входных данных** - проверка корректности перед расчетом
4. **Обновление результатов** - сохранение в БД

### Алгоритм расчета

#### Подготовка данных
1. **Получение данных** из таблиц `moex_bonds`, `tbank_bonds`, `tbank_prices`
2. **Валидация полей** на NULL и корректность
3. **Получение текущей даты** для расчетов

#### Последовательность расчетов
1. **Дневной купон** → НКД
2. **Затраты** → Купоны до погашения → Доход
3. **Чистая прибыль** → Годовая доходность

#### Условия расчета
- Все обязательные поля должны быть заполнены
- Дата погашения должна быть в будущем
- Цена должна быть положительной

#### Расчёт по дате оферты

Для облигаций с офертой необходимо рассчитывать дополнительные показатели доходности, учитывающие возможность досрочного погашения по номиналу в дату оферты.

##### Таблица показателей по дате оферты

| Показатель                   | Поле БД            | Формула расчета                                              | Описание                                    |
|------------------------------|--------------------|--------------------------------------------------------------|---------------------------------------------|
| Купоны до оферты             | coupon_offer       | `(offer_date - now() - 1) × coupon_daily + nkd`              | Доход от купонов до даты оферты             |
| Доход до оферты              | profit_offer       | `face_value + coupon_offer - costs`                          | Валовый доход при досрочном погашении       |
| Чистая прибыль до оферты     | profit_net_offer   | `profit_offer × (1 - ndfl_percent / 100)`                    | Доход после налогов при досрочном погашении |
| Годовая доходность до оферты | annual_yield_offer | `profit_net_offer / costs_offer × 365 / days_to_offer × 100` | Годовая доходность при досрочном погашении  |

##### Дополнительные поля БД

Для реализации расчетов по дате оферты необходимо добавить следующие поля в таблицу `bonds_calc`:

**Расчетные поля для оферты:**
- `coupon_offer` (DECIMAL(15,8)) - сумма купонов до даты оферты
- `profit_offer` (DECIMAL(15,8)) - валовый доход при досрочном погашении
- `profit_net_offer` (DECIMAL(15,8)) - чистый доход после налогов при оферте
- `annual_yield_offer` (DECIMAL(8,4)) - годовая доходность при досрочном погашении

##### Алгоритм расчета по дате оферты

**Условия для расчета:**
1. `offer_date` не NULL и больше текущей даты

**Последовательность расчетов:**
1. Дневной купон, НКД, затраты используются те же, что и при обычном расчёте.
4. Далее вычисляется Купон до оферты, Доход до оферты, Чистая прибыль до оферты и Годовая доходность до оферты

## API

### Endpoints
- `POST /api/bonds/calculate` - запуск расчета для всех облигаций
- `POST /api/bonds/calculate/{isin}` - расчет для конкретной облигации

### Автоматизация
- **Периодичность**: настраивается через интервал в минутах
- **Конфигурация**: `bonds.calc-interval`
- **Рекомендуемая частота**: каждые 30-60 минут
- **Обновление показателей**: должно запускаться автоматически после каждого сеанса обновления цен

## Конфигурация

```yaml
calc:
  period-minutes: 30             # интервал пересчета в минутах
  ndfl: 13                       # подоходный налог в процентах

  precision: 8                   # точность расчетов (знаков после запятой)
  min-days-to-maturity: 1        # минимальное количество дней до погашения
  max-yield: 50                  # максимальная разумная доходность в процентах
```

В коде не должно быть никаких значений конфигурации по умолчанию.

## Обработка данных

### Валидация входных данных
- **Обязательные поля**: price, face_value, coupon_value, maturity_date
- **Числовые ограничения**: положительные значения, разумные диапазоны
- **Временные ограничения**: дата погашения в будущем

### Точность расчетов
- **Денежные суммы**: BigDecimal с точностью до 8 знаков после запятой
- **Проценты**: округление до 4 знаков после запятой
- **Дни**: целые числа

### Обработка ошибок
- **Пропуск некорректных записей** с логированием
- **Продолжение расчета** при ошибках в отдельных облигациях
- **Сохранение частичных результатов**

## Логирование

### Уровень DEBUG
- Детали расчета для каждой облигации
- Промежуточные значения показателей
- Причины пропуска записей

### Уровень INFO
- Начало/окончание массового расчета
- Статистика: всего обработано, рассчитано, пропущено
- Время выполнения операций

### Уровень ERROR
- Критические ошибки расчета
- Проблемы с БД
- Некорректные конфигурационные параметры

## Производительность

### Оптимизация
- **Batch обновление**: группированное сохранение результатов
- **Индексы БД**: оптимизация запросов по ISIN и доходности
- **Кэширование**: повторное использование постоянных параметров

### Масштабирование
- **Пагинация**: обработка больших объемов данных порциями
- **Параллелизация**: многопоточные расчеты при возможности
- **Мониторинг**: отслеживание времени выполнения и ресурсов

## Интеграция

### Зависимости
- **Market Data**: актуальные цены облигаций
- **Instruments**: основные характеристики инструментов
- **Configuration**: параметры расчета

### Потребители
- **Web Interface**: отображение рассчитанных показателей
- **API**: предоставление данных внешним системам
- **Reporting**: генерация отчетов по доходности