# Модуль расчета доходности

## Назначение модуля

Расчет ключевых показателей доходности облигаций на основе рыночных данных и характеристик инструментов.

## Рассчитываемые показатели

### Таблица показателей

| Показатель          | Поле БД           | Формула расчета                                     | Описание                               |
|---------------------|-------------------|-----------------------------------------------------|----------------------------------------|
| Дневной купон       | coupon_daily      | `coupon_value / coupon_length`                      | Ежедневное начисление купонного дохода |
| НКД                 | nkd               | `(coupon_days_passed + 1) × coupon_daily`           | Накопленный купонный доход             |
| Затраты             | costs             | `price + nkd + fee`                                 | Общие затраты на покупку               |
| Комиссия            | fee               | `costs × fee_percent / 100`                         | Брокерская комиссия от сделки          |
| Купоны до погашения | coupon_redemption | `(maturity_date - now() - 1) × coupon_daily + nkd`  | Доход от купонов до погашения          |
| Доход               | profit            | `face_value + coupon_redemption - costs`            | Валовый доход от инвестиции            |
| Чистая прибыль      | profit_net        | `profit × (1 - ndfl_percent / 100)`                 | Доход после уплаты налогов             |
| Годовая доходность  | annual_yield      | `profit_net / costs × 365 / days_to_maturity × 100` | Годовая доходность в процентах         |

### Параметры расчета

Конфигурируются в файле настроек:
- **broker.fee** - ставка брокерской комиссии (в процентах)
- **broker.ndfl** - ставка подоходного налога (в процентах)
- **bonds.calc-interval** - интервал пересчета (в минутах)

## Функциональность

### Основные операции
1. **Индивидуальный расчет** - для конкретной облигации по ISIN
2. **Массовый расчет** - для всех облигаций в БД
3. **Валидация входных данных** - проверка корректности перед расчетом
4. **Обновление результатов** - сохранение в БД

### Алгоритм расчета

#### Подготовка данных
1. **Получение данных** из таблицы `bonds`
2. **Валидация полей** на NULL и корректность
3. **Получение текущей даты** для расчетов

#### Последовательность расчетов
1. **Дневной купон** → НКД → Комиссия
2. **Затраты** → Купоны до погашения → Доход
3. **Чистая прибыль** → Годовая доходность

#### Условия расчета
- Все обязательные поля должны быть заполнены
- Дата погашения должна быть в будущем
- Цена должна быть положительной

## API

### Endpoints
- `POST /api/bonds/calculate` - запуск расчета для всех облигаций
- `POST /api/bonds/calculate/{isin}` - расчет для конкретной облигации

### Автоматизация
- **Периодичность**: настраивается через интервал в минутах
- **Конфигурация**: `bonds.calc-interval`
- **Рекомендуемая частота**: каждые 30-60 минут

## Конфигурация

```yaml
calc:
  period-minutes: 30             # интервал пересчета в минутах
  broker:
    fee: 0.05                    # комиссия брокера в процентах
  ndfl: 13                       # подоходный налог в процентах

  precision: 8                   # точность расчетов (знаков после запятой)
  min-days-to-maturity: 1        # минимальное количество дней до погашения
  max-yield: 50                  # максимальная разумная доходность в процентах
```

## Обработка данных

### Валидация входных данных
- **Обязательные поля**: price, face_value, coupon_value, maturity_date
- **Числовые ограничения**: положительные значения, разумные диапазоны
- **Временные ограничения**: дата погашения в будущем

### Точность расчетов
- **Денежные суммы**: BigDecimal с точностью до 8 знаков после запятой
- **Проценты**: округление до 4 знаков после запятой
- **Дни**: целые числа

### Обработка ошибок
- **Пропуск некорректных записей** с логированием
- **Продолжение расчета** при ошибках в отдельных облигациях
- **Сохранение частичных результатов**

## Логирование

### Уровень DEBUG
- Детали расчета для каждой облигации
- Промежуточные значения показателей
- Причины пропуска записей

### Уровень INFO
- Начало/окончание массового расчета
- Статистика: всего обработано, рассчитано, пропущено
- Время выполнения операций

### Уровень ERROR
- Критические ошибки расчета
- Проблемы с БД
- Некорректные конфигурационные параметры

## Производительность

### Оптимизация
- **Batch обновление**: группированное сохранение результатов
- **Индексы БД**: оптимизация запросов по ISIN и доходности
- **Кэширование**: повторное использование постоянных параметров

### Масштабирование
- **Пагинация**: обработка больших объемов данных порциями
- **Параллелизация**: многопоточные расчеты при возможности
- **Мониторинг**: отслеживание времени выполнения и ресурсов

## Интеграция

### Зависимости
- **Market Data**: актуальные цены облигаций
- **Instruments**: основные характеристики инструментов
- **Configuration**: параметры расчета

### Потребители
- **Web Interface**: отображение рассчитанных показателей
- **API**: предоставление данных внешним системам
- **Reporting**: генерация отчетов по доходности